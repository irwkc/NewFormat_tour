// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  owner
  owner_assistant
  partner
  partner_controller
  manager
  promoter
}

enum TicketStatus {
  sold
  used
  cancelled
}

enum PaymentMethod {
  online_yookassa
  cash
  acquiring
}

enum PaymentStatus {
  pending
  completed
  failed
}

enum ModerationStatus {
  pending
  approved
  rejected
}

enum CommissionType {
  percentage
  fixed
}

enum BalanceType {
  balance
  debt_to_company
}

enum TransactionType {
  credit
  debit
}

model User {
  id                      String   @id @default(uuid())
  email                   String?  @unique
  promoter_id             Int?     @unique
  full_name               String?
  phone                   String?
  password_hash           String
  role                    UserRole
  main_owner_id           String?  @map("main_owner_id")
  email_confirmed         Boolean  @default(false)
  email_confirmation_token String?
  password_reset_token    String?
  password_reset_expires  DateTime?
  created_by_user_id      String?  @map("created_by_user_id")
  main_partner_id         String?  @map("main_partner_id")
  created_at              DateTime @default(now())
  updated_at              DateTime @updatedAt
  is_active               Boolean  @default(true)
  photo_url               String?
  balance                 Decimal  @default(0) @db.Decimal(10, 2)
  debt_to_company         Decimal  @default(0) @db.Decimal(10, 2)

  // Relations
  mainOwner               User?     @relation("OwnerAssistant", fields: [main_owner_id], references: [id])
  assistants              User[]    @relation("OwnerAssistant")
  mainPartner             User?     @relation("PartnerController", fields: [main_partner_id], references: [id])
  controllers             User[]    @relation("PartnerController")
  createdBy               User?     @relation("CreatedBy", fields: [created_by_user_id], references: [id])
  createdUsers            User[]    @relation("CreatedBy")
  
  categories              Category[]
  toursCreated            Tour[]        @relation("TourCreatedBy")
  toursModerated          Tour[]        @relation("TourModeratedBy")
  salesAsSeller           Sale[]    @relation("SaleSeller")
  salesAsPromoter         Sale[]    @relation("SalePromoter")
  issuedItems             IssuedItem[]
  issuedItemsReceived     IssuedItem[] @relation("IssuedToUser")
  issuedItemsReturned     IssuedItem[] @relation("ReturnedByUser")
  invitationsSent          InvitationToken[] @relation("InvitationInvitedBy")
  invitationsUsed          InvitationToken[] @relation("InvitationUsedBy")
  balanceHistory          BalanceHistory[]
  ticketUsedBy            Ticket[]  @relation("UsedByUser")
  ticketCancelledBy       Ticket[]  @relation("CancelledByUser")
  balancePerformedBy      BalanceHistory[] @relation("PerformedByUser")
  
  @@index([email])
  @@index([promoter_id])
  @@index([role])
  @@map("users")
}

model Category {
  id                String   @id @default(uuid())
  name              String   @unique
  created_by_user_id String  @map("created_by_user_id")
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relations
  createdBy         User     @relation(fields: [created_by_user_id], references: [id])
  tours             Tour[]

  @@map("categories")
}

model Tour {
  id                    String          @id @default(uuid())
  created_by_user_id    String          @map("created_by_user_id")
  category_id           String          @map("category_id")
  company               String
  departure_time        DateTime
  date                  DateTime        @db.Date
  max_places            Int
  partner_min_adult_price Decimal       @map("partner_min_adult_price") @db.Decimal(10, 2)
  partner_min_child_price Decimal       @map("partner_min_child_price") @db.Decimal(10, 2)
  partner_min_concession_price Decimal? @map("partner_min_concession_price") @db.Decimal(10, 2)
  moderation_status     ModerationStatus @default(pending)
  moderated_by_user_id  String?         @map("moderated_by_user_id")
  moderated_at          DateTime?
  owner_min_adult_price Decimal?        @map("owner_min_adult_price") @db.Decimal(10, 2)
  owner_min_child_price Decimal?        @map("owner_min_child_price") @db.Decimal(10, 2)
  owner_min_concession_price Decimal?   @map("owner_min_concession_price") @db.Decimal(10, 2)
  commission_type       CommissionType?
  commission_percentage Decimal?        @db.Decimal(5, 2)
  commission_fixed_amount Decimal?      @db.Decimal(10, 2)
  is_sale_stopped       Boolean         @default(false)
  current_booked_places Int             @default(0)
  flight_number         String
  created_at            DateTime        @default(now())
  updated_at            DateTime        @updatedAt

  // Relations
  createdBy             User            @relation("TourCreatedBy", fields: [created_by_user_id], references: [id])
  category              Category        @relation(fields: [category_id], references: [id])
  moderatedBy           User?           @relation("TourModeratedBy", fields: [moderated_by_user_id], references: [id])
  sales                 Sale[]
  tickets               Ticket[]

  @@index([moderation_status])
  @@index([category_id])
  @@index([created_by_user_id])
  @@map("tours")
}

model Sale {
  id                  String        @id @default(uuid())
  tour_id             String        @map("tour_id")
  seller_user_id      String        @map("seller_user_id")
  promoter_user_id    String?       @map("promoter_user_id")
  adult_count         Int
  child_count         Int           @default(0)
  concession_count    Int           @default(0)
  adult_price         Decimal       @db.Decimal(10, 2)
  child_price         Decimal?      @db.Decimal(10, 2)
  concession_price    Decimal?      @db.Decimal(10, 2)
  total_amount        Decimal       @db.Decimal(10, 2)
  payment_method      PaymentMethod
  payment_status      PaymentStatus @default(pending)
  yookassa_payment_id String?
  yookassa_payment_url String?
  payment_link_token  String?       @unique
  payment_link_url    String?
  receipt_photo_url   String?
  customer_email      String?
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt

  // Relations
  tour                Tour          @relation(fields: [tour_id], references: [id])
  seller              User          @relation("SaleSeller", fields: [seller_user_id], references: [id])
  promoter            User?         @relation("SalePromoter", fields: [promoter_user_id], references: [id])
  ticket              Ticket?
  yookassaPayments    YookassaPayment[]
  balanceHistory      BalanceHistory[]

  @@index([tour_id])
  @@index([seller_user_id])
  @@index([promoter_user_id])
  @@index([payment_status])
  @@map("sales")
}

model Ticket {
  id                  String      @id @default(uuid())
  sale_id             String      @unique @map("sale_id")
  tour_id             String      @map("tour_id")
  adult_count         Int
  child_count         Int         @default(0)
  ticket_number       String?     @unique
  ticket_photo_url    String?
  ticket_status       TicketStatus @default(sold)
  cancelled_at        DateTime?
  cancelled_by_user_id String?    @map("cancelled_by_user_id")
  qr_code_data        String?
  qr_code_url         String?
  ticket_pdf_url      String?
  used_at             DateTime?
  used_by_user_id     String?     @map("used_by_user_id")
  created_at          DateTime    @default(now())
  updated_at          DateTime    @updatedAt

  // Relations
  sale                Sale        @relation(fields: [sale_id], references: [id])
  tour                Tour        @relation(fields: [tour_id], references: [id])
  usedBy              User?       @relation("UsedByUser", fields: [used_by_user_id], references: [id])
  cancelledBy         User?       @relation("CancelledByUser", fields: [cancelled_by_user_id], references: [id])
  balanceHistory      BalanceHistory[]

  @@index([tour_id])
  @@index([ticket_status])
  @@index([ticket_number])
  @@index([qr_code_data])
  @@map("tickets")
}

model YookassaPayment {
  id          String   @id @default(uuid())
  sale_id     String   @map("sale_id")
  payment_id  String
  status      String
  amount      Decimal  @db.Decimal(10, 2)
  currency    String   @default("RUB")
  metadata    Json?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  // Relations
  sale        Sale     @relation(fields: [sale_id], references: [id])

  @@index([sale_id])
  @@index([payment_id])
  @@map("yookassa_payments")
}

model InvitationToken {
  id              String   @id @default(uuid())
  token           String   @unique
  invited_by_user_id String @map("invited_by_user_id")
  target_role     String
  is_used         Boolean  @default(false)
  used_by_user_id String?  @map("used_by_user_id")
  expires_at      DateTime
  created_at      DateTime @default(now())
  used_at         DateTime?

  // Relations
  invitedBy       User     @relation("InvitationInvitedBy", fields: [invited_by_user_id], references: [id])
  usedBy          User?    @relation("InvitationUsedBy", fields: [used_by_user_id], references: [id])

  @@index([token])
  @@index([invited_by_user_id])
  @@map("invitation_tokens")
}

model IssuedItem {
  id                  String   @id @default(uuid())
  issued_by_user_id   String   @map("issued_by_user_id")
  issued_to_user_id   String   @map("issued_to_user_id")
  item_name           String
  item_description    String?
  item_photo_url      String
  is_returned         Boolean  @default(false)
  returned_at         DateTime?
  returned_by_user_id String?  @map("returned_by_user_id")
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  // Relations
  issuedBy            User     @relation(fields: [issued_by_user_id], references: [id])
  issuedTo            User     @relation("IssuedToUser", fields: [issued_to_user_id], references: [id])
  returnedBy          User?    @relation("ReturnedByUser", fields: [returned_by_user_id], references: [id])

  @@index([issued_to_user_id])
  @@index([issued_by_user_id])
  @@map("issued_items")
}

model BalanceHistory {
  id                  String          @id @default(uuid())
  user_id             String          @map("user_id")
  balance_type        BalanceType
  transaction_type    TransactionType
  amount              Decimal         @db.Decimal(10, 2)
  balance_before      Decimal         @db.Decimal(10, 2)
  balance_after       Decimal         @db.Decimal(10, 2)
  description         String
  ticket_id           String?         @map("ticket_id")
  sale_id             String?         @map("sale_id")
  performed_by_user_id String?        @map("performed_by_user_id")
  created_at          DateTime        @default(now())

  // Relations
  user                User            @relation(fields: [user_id], references: [id])
  ticket              Ticket?         @relation(fields: [ticket_id], references: [id])
  sale                Sale?           @relation(fields: [sale_id], references: [id])
  performedBy         User?           @relation("PerformedByUser", fields: [performed_by_user_id], references: [id])

  @@index([user_id])
  @@index([ticket_id])
  @@index([sale_id])
  @@index([created_at])
  @@map("balance_history")
}
