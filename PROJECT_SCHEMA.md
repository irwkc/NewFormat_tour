# Схема проекта: Система управления продажей экскурсий

## Роли пользователей

### 1. Владелец (Owner)
- ✅ **Единственный** владелец в системе (создается изначально при установке)
- ✅ **Создание помощника владельца через ЛК** (одна почта, разные пароли) - создается владельцем в разделе Настройки
- ✅ Создание и управление категориями экскурсий (например: Теплоход, Катер)
- ✅ Установка минимальной цены за детский и взрослый билет для каждой экскурсии
- ✅ Остановка продаж на любую экскурсию
- ✅ Удаление экскурсий (только если нет проданных билетов)
- ✅ Автоматическая остановка продаж при заполнении мест (по оплаченным билетам)
- ✅ Просмотр всей статистики продаж и метрик (все возможные метрики)
- ✅ Отмена билетов (после отмены билет переходит в статус "отменен" и остается в этом статусе)
- ✅ Выдача вещей промоутерам и менеджерам:
  - Поиск промоутера/менеджера по ID
  - Выдача вещи (название - свободный ввод, например: кофта, эквайринг)
  - Прикрепление фото выданной вещи
  - Неограниченное количество вещей можно выдавать
- ✅ Просмотр истории выданных вещей с фото
- ✅ Удаление выданных вещей у промоутеров и менеджеров
- ✅ Модерация экскурсий партнеров:
  - Просмотр экскурсий на модерации
  - Установка минимальных цен владельца (владелец может изменить их даже после модерации, даже если часть билетов продана)
  - Установка типа комиссии (процент или фиксированная сумма) и её значения
  - Комиссию можно изменять даже если часть билетов уже продана
  - Одобрение/отклонение экскурсии
- ✅ Просмотр списка промоутеров с их балансами
- ✅ Просмотр списка менеджеров с их балансами и балансами "Должен компании"
- ✅ Обнуление балансов у промоутеров и менеджеров (через личный кабинет)

### 1.1. Помощник владельца (Owner Assistant)
- ✅ Доступ по той же почте, что и владелец, но с другим паролем
- ✅ Пароль можно задать при создании и изменить в настройках владельца
- ✅ Выдача вещей промоутерам и менеджерам:
  - Поиск промоутера/менеджера по ID
  - Выдача вещи (название - свободный ввод, например: кофта, эквайринг)
  - Прикрепление фото выданной вещи
  - Неограниченное количество вещей можно выдавать
- ✅ Удаление выданных вещей у промоутеров и менеджеров (поиск по ID промоутера/менеджера)

### 2. Партнер (Partner)
- ✅ **Неограниченное количество партнеров** в системе (владелец может приглашать множество партнеров)
- ✅ Добавление своих экскурсий (время, дата, количество мест, компания, рейс, категория)
- ✅ Установка своих минимальных цен за детский и взрослый билет при создании экскурсии
- ✅ После создания экскурсия автоматически идет на модерацию к владельцу
- ✅ Пока экскурсия не прошла модерацию - она не отображается у промоутеров и менеджеров и на неё нельзя продать билеты
- ✅ После модерации партнер не может ничего изменять в экскурсии
- ✅ Остановка продаж только на СВОИ экскурсии (не может остановить продажи на экскурсии других партнеров)
- ✅ Удаление своих экскурсий (только если нет проданных билетов)
- ✅ Автоматическая остановка продаж при заполнении мест (для своих экскурсий)
- ✅ Просмотр метрик по своим экскурсиям
- ✅ Проверка билетов на входе:
  - Сканирование QR кодов билетов
  - Ввод номеров билетов (формат AA00000000 - 2 английские заглавные буквы + 8 цифр)
  - Подтверждение использования билетов
- ✅ **Создание альтернативного профиля контролера через ЛК** - создается партнером самостоятельно в разделе Настройки

### 2.1. Партнер - Альтернативный профиль (Partner Controller)
- ✅ Доступ по той же почте, что и основной профиль, но с другим паролем
- ✅ Пароль можно задать при регистрации и изменить в настройках основного профиля
- ✅ Может только проверять билеты на входе (ограниченный доступ, без других функций):
  - Сканировать QR коды билетов
  - Вводить номера билетов (формат AA00000000 - 2 английские заглавные буквы + 8 цифр)
- ✅ При проверке билета видит информацию:
  - На какую экскурсию куплен билет
  - Количество взрослых мест
  - Количество детских мест (если есть)
- ✅ После просмотра информации есть кнопки:
  - "Подтвердить" → статус билета меняется на `used` (Использовано)
  - "Отмена" → статус билета остается `sold` (Продано)

### 3. Менеджер (Manager)
- ✅ При регистрации обязательно прикладывает свою фотографию лица
- ✅ Продажа билетов с указанием:
  - Цены взрослого билета (≥ минимальной цены владельца)
  - Цены детского билета (≥ минимальной цены владельца, опционально)
  - Количества взрослых и детских билетов
- ✅ Поиск и фильтрация экскурсий по категориям (видит только одобренные экскурсии)
- ✅ Способы продажи:
  - **Онлайн (ЮКасса)**: QR-код для клиента или отправка ссылки
  - **Наличные**: требует фото пронумерованного бумажного билета
  - **Эквайринг**: требует фото чека эквайринга
- ✅ При продаже наличкой/эквайрингом может указать ID промоутера (промоутер подходит и просит продать за него) → продажа записывается на промоутера
- ✅ Промоутеры **независимы** от менеджеров - нет постоянной связи, только разовые продажи
- ✅ Просмотр своих продаж
- ✅ Просмотр баланса в личном кабинете:
  - Баланс пополняется только когда билет переходит из статуса "продано" (sold) в "использовано" (used)
  - Сумма пополнения зависит от типа комиссии экскурсии:
    - Если процент: процент от суммы продажи билета
    - Если фиксированная сумма: фиксированная сумма за продажу
- ✅ Просмотр истории баланса в личном кабинете:
  - История пополнений баланса (с датами и подробной информацией)
  - История обнулений баланса (выплаты владельцем с датами)
  - Для каждой операции: тип операции (пополнение/выплата), сумма, дата, описание, баланс до и после операции
- ✅ Просмотр баланса "Должен компании" в личном кабинете:
  - Баланс "Должен компании" появляется только при продажах за наличку
  - При продаже за наличку за себя:
    - Баланс пополняется на процент/фиксированную сумму от продажи (только при статусе `used`)
    - Баланс "Должен компании" пополняется на полную сумму билета (при статусе `used` или `cancelled`)
  - При продаже за наличку за промоутера:
    - Баланс промоутера пополняется на его процент/фиксированную сумму (только при статусе `used`)
    - Баланс "Должен компании" у менеджера пополняется на полную сумму билета (при статусе `used` или `cancelled`)
- ✅ Просмотр выданных вещей в личном кабинете:
  - Раздел с выданными вещами
  - Название вещи (описание)
  - Фото выданной вещи
  - Дата выдачи

### 4. Промоутер (Promoter)
- ✅ При регистрации обязательно прикладывает свою фотографию лица
- ✅ Продажа билетов с указанием:
  - Цены взрослого билета (≥ минимальной цены владельца)
  - Цены детского билета (≥ минимальной цены владельца, опционально)
  - Количества взрослых и детских билетов
- ✅ Поиск и фильтрация экскурсий по категориям (видит только одобренные экскурсии)
- ✅ Способы продажи:
  - **Онлайн (ЮКасса)**: только отправка ссылки или показ QR-кода
- ✅ Просмотр своих продаж
- ✅ Просмотр суммы продаж в личном кабинете (пополняется только когда билет переходит из статуса "продано" в "использовано")
- ✅ Просмотр выданных вещей в личном кабинете:
  - Раздел с выданными вещами
  - Название вещи (описание)
  - Фото выданной вещи
  - Дата выдачи

---

## Схема базы данных

### Таблица: users
```
id: UUID (Primary Key)
email: String (Unique, nullable) // nullable только для промоутеров (они входят по ID)
promoter_id: Integer (Unique, nullable) // уникальный числовой ID промоутера (генерируется при регистрации, показывается в ЛК и на почте)
full_name: String // ФИО (обязательно для всех ролей кроме владельца)
phone: String // номер телефона (обязательно для всех ролей кроме владельца)
password_hash: String
role: Enum (owner, owner_assistant, partner, partner_controller, manager, promoter) // owner_assistant - помощник владельца, partner_controller - альтернативный профиль партнера для контроля
main_owner_id: UUID (Foreign Key → users.id, nullable) // для помощника владельца - ссылка на основной профиль владельца
email_confirmed: Boolean (default: false) // подтверждение почты
email_confirmation_token: String (nullable) // токен для подтверждения email
password_reset_token: String (nullable) // токен для восстановления пароля
password_reset_expires: DateTime (nullable) // срок действия токена восстановления
created_by_user_id: UUID (Foreign Key → users.id, nullable) // кто создал/пригласил пользователя
main_partner_id: UUID (Foreign Key → users.id, nullable) // для альтернативного профиля партнера - ссылка на основной профиль партнера
created_at: DateTime
updated_at: DateTime
is_active: Boolean
photo_url: String (nullable) // фото лица промоутера/менеджера (обязательно при регистрации)
balance: Decimal (default: 0.00) // баланс промоутера/менеджера (пополняется только когда билет переходит из sold в used)
debt_to_company: Decimal (default: 0.00) // баланс "Должен компании" только для менеджеров (пополняется при статусе used или cancelled)
```

**Важно:**
- Промоутеры входят в систему по `promoter_id` + пароль
- Менеджеры входят по `email` + пароль
- Владелец входит по `email` + пароль
- Партнер (основной профиль) входит по `email + пароль`
- Партнер (альтернативный профиль контролера) входит по `email + пароль` (тот же email, но другой пароль)
- Помощник владельца (owner_assistant) входит по `email + пароль` (тот же email, что и владелец, но другой пароль)
- Email обязателен для всех, кроме промоутеров (у них может быть nullable, но желательно заполнить)
- Промоутер получает `promoter_id` на email после подтверждения почты
- **Фото лица обязательно при регистрации для промоутеров и менеджеров** (`photo_url` не может быть null)
- **Помощник владельца создается владельцем через ЛК** в разделе Настройки (та же почта, отдельный пароль)
- **Контролер партнера создается партнером через ЛК** в разделе Настройки (та же почта, отдельный пароль)

### Таблица: categories (Категории экскурсий)
```
id: UUID (Primary Key)
name: String (Unique) // название категории (например: Теплоход, Катер)
created_by_user_id: UUID (Foreign Key → users.id) // всегда владелец
created_at: DateTime
updated_at: DateTime
```

**Важно:**
- Категории создает только владелец
- Категории используются для фильтрации и поиска экскурсий
- При создании экскурсии обязательно выбирается категория

### Таблица: tours (Экскурсии)
```
id: UUID (Primary Key)
created_by_user_id: UUID (Foreign Key → users.id) // только партнер (владелец не может создавать экскурсии)
category_id: UUID (Foreign Key → categories.id) // категория экскурсии (обязательно)
company: String
departure_time: DateTime
date: Date
max_places: Integer
partner_min_adult_price: Decimal // минимальная цена взрослого билета, которую установил партнер при создании
partner_min_child_price: Decimal // минимальная цена детского билета, которую установил партнер при создании
moderation_status: Enum (pending, approved, rejected) // статус модерации: pending (на модерации), approved (одобрена), rejected (отклонена)
moderated_by_user_id: UUID (Foreign Key → users.id, nullable) // кто модерировал (всегда владелец)
moderated_at: DateTime (nullable) // когда была пройдена модерация
owner_min_adult_price: Decimal (nullable) // минимальная цена взрослого билета, которую установил владелец при модерации
owner_min_child_price: Decimal (nullable) // минимальная цена детского билета, которую установил владелец при модерации
commission_type: Enum (percentage, fixed) // тип комиссии: percentage (процент) или fixed (фиксированная сумма)
commission_percentage: Decimal (nullable) // процент от продажи для промоутера/менеджера (например, 21)
commission_fixed_amount: Decimal (nullable) // фиксированная сумма для промоутера/менеджера за продажу
is_sale_stopped: Boolean (default: false)
current_booked_places: Integer (default: 0) // количество билетов со статусом 'sold' (считается автоматически из таблицы tickets)
flight_number: String
created_at: DateTime
updated_at: DateTime
```

**Важно:**
- При создании экскурсии обязательно выбирается категория
- Экскурсию можно удалить только если на неё нет проданных билетов (нет записей в таблице tickets со статусом `sold` или `used`)
- Удаление доступно владельцу (любые экскурсии) и партнеру (только свои экскурсии, не может удалить экскурсии других партнеров)

### Таблица: sales (Продажи)
```
id: UUID (Primary Key)
tour_id: UUID (Foreign Key → tours.id)
seller_user_id: UUID (Foreign Key → users.id) // кто продал (менеджер или промоутер)
promoter_user_id: UUID (Foreign Key → users.id, nullable) // если менеджер продал за промоутера (промоутер сам пришел и попросил)
adult_count: Integer
child_count: Integer
adult_price: Decimal
child_price: Decimal
total_amount: Decimal
payment_method: Enum (online_yookassa, cash, acquiring)
payment_status: Enum (pending, completed, failed)
yookassa_payment_id: String (nullable)
yookassa_payment_url: String (nullable)
payment_link_token: String (Unique, nullable) // токен для публичной страницы заказа (QR и ссылка ведут сюда)
payment_link_url: String (nullable) // публичная ссылка на страницу заказа (для QR и отправки клиенту)
receipt_photo_url: String (nullable) // для эквайринга (фото чека эквайринга)
customer_email: String (nullable) // для отправки PDF чека с QR (при онлайн оплате)
created_at: DateTime
updated_at: DateTime
```

### Таблица: tickets (Билеты)
```
id: UUID (Primary Key)
sale_id: UUID (Foreign Key → sales.id, Unique) // один билет на одну продажу
tour_id: UUID (Foreign Key → tours.id)
adult_count: Integer // количество взрослых мест в билете (>= 1)
child_count: Integer // количество детских мест в билете (>= 0, может быть 0 если только взрослые)
ticket_number: String (Unique, nullable) // номер билета для налички/эквайринга (формат: AA00000000 - 2 английские заглавные буквы + 8 цифр)
ticket_photo_url: String (nullable) // фото пронумерованного бумажного билета (для налички/эквайринга)
ticket_status: Enum (sold, used, cancelled) // статус билета: Продано (sold) - сразу после продажи, Использовано (used) - после сканирования на входе, Отменено (cancelled) - отменен владельцем (остается в этом статусе, не переходит в used)
cancelled_at: DateTime (nullable) // когда билет был отменен владельцем
cancelled_by_user_id: UUID (Foreign Key → users.id, nullable) // кто отменил билет (всегда владелец)
qr_code_data: String (nullable) // данные для QR кода на входе (для онлайн билетов)
qr_code_url: String (nullable) // URL для сканирования QR (публичная страница с информацией о билете)
ticket_pdf_url: String (nullable) // ссылка на сгенерированный PDF с билетом и QR для контроля (для онлайн)
used_at: DateTime (nullable) // когда билет был использован (при проверке на входе)
used_by_user_id: UUID (Foreign Key → users.id, nullable) // кто проверил билет на входе (контролер)
created_at: DateTime
updated_at: DateTime
```

**Важно:**
- **Один билет на одну продажу** - содержит информацию обо всех местах в заказе
  - Пример 1: 2 взрослых и 1 детский → билет с `adult_count=2, child_count=1`
  - Пример 2: только 2 взрослых → билет с `adult_count=2, child_count=0` (детских мест нет)
- `child_count` может быть 0, если в заказе только взрослые билеты
- При онлайн оплате: генерируется один QR код и один PDF для всего заказа
  - Если `child_count > 0` → показывается информация о детских местах и цене
  - Если `child_count = 0` → информация о детских местах не показывается
- При наличке/эквайринге: менеджер вводит один номер билета в формате `AA00000000` (2 английские заглавные буквы + 8 цифр) и загружает одно фото
  - Билеты уже есть физически, менеджер вводит номер сам (генерация не требуется)
- Номер билета уникален в системе
- Статус билета: 
  - `sold` (Продано) - сразу после продажи
  - `used` (Использовано) - после проверки на входе
  - `cancelled` (Отменено) - отменен владельцем (остается в этом статусе, не переходит в used)

### Таблица: yookassa_payments (Платежи ЮКасса)
```
id: UUID (Primary Key)
sale_id: UUID (Foreign Key → sales.id)
payment_id: String // ID платежа в ЮКасса
status: String
amount: Decimal
currency: String (default: 'RUB')
metadata: JSON
created_at: DateTime
updated_at: DateTime
```

### Таблица: invitation_tokens (Пригласительные ссылки)
```
id: UUID (Primary Key)
token: String (Unique) // уникальный токен для ссылки
invited_by_user_id: UUID (Foreign Key → users.id) // кто создал приглашение
target_role: Enum (manager, promoter, partner) // для кого приглашение (привязка к роли)
is_used: Boolean (default: false) // использована ли ссылка (одна ссылка = один аккаунт)
used_by_user_id: UUID (Foreign Key → users.id, nullable) // кто использовал ссылку
expires_at: DateTime // срок действия приглашения (1 сутки = 24 часа от момента создания)
created_at: DateTime
used_at: DateTime (nullable)
```

### Таблица: issued_items (Выданные вещи)
```
id: UUID (Primary Key)
issued_by_user_id: UUID (Foreign Key → users.id) // кто выдал вещь (владелец или помощник владельца)
issued_to_user_id: UUID (Foreign Key → users.id) // кому выдана вещь (промоутер или менеджер)
item_name: String // название вещи (свободный ввод, например: кофта, эквайринг)
item_description: String (nullable) // дополнительное описание вещи
item_photo_url: String // фото выданной вещи (обязательно)
is_returned: Boolean (default: false) // возвращена ли вещь (убрана)
returned_at: DateTime (nullable) // когда вещь была возвращена/убрана
returned_by_user_id: UUID (Foreign Key → users.id, nullable) // кто убрал вещь (владелец или помощник)
created_at: DateTime
updated_at: DateTime
```

**Важно:**
- Владелец и помощник владельца могут выдавать неограниченное количество вещей промоутерам и менеджерам
- При выдаче вещи обязательно указывается название (свободный ввод) и прикрепляется фото
- Помощник владельца и владелец могут убрать вещь (поиск промоутера/менеджера по ID)
- История выданных вещей хранится с фото (даже после возврата вещи)

### Таблица: balance_history (История баланса)
```
id: UUID (Primary Key)
user_id: UUID (Foreign Key → users.id) // промоутер или менеджер
balance_type: Enum (balance, debt_to_company) // тип баланса: balance (обычный баланс) или debt_to_company (долг компании)
transaction_type: Enum (credit, debit) // тип операции: credit (пополнение) или debit (обнуление/выплата)
amount: Decimal // сумма операции (положительное число)
balance_before: Decimal // баланс до операции
balance_after: Decimal // баланс после операции
description: String // подробное описание операции (например: "Пополнение от продажи билета #123", "Выплата владельцем")
ticket_id: UUID (Foreign Key → tickets.id, nullable) // ID билета, если операция связана с продажей/отменой билета
sale_id: UUID (Foreign Key → sales.id, nullable) // ID продажи, если операция связана с продажей
performed_by_user_id: UUID (Foreign Key → users.id, nullable) // кто выполнил операцию (владелец при обнулении, система при пополнении)
created_at: DateTime
```

**Важно:**
- История записывается при каждом пополнении баланса (при подтверждении билета на входе)
- История записывается при каждом обнулении баланса владельцем (выплата)
- История записывается при пополнении/обнулении баланса "Должен компании"
- В описании указывается подробная информация: номер билета, сумма продажи, тип операции и т.д.
- История отображается в личном кабинете промоутера/менеджера с датами и подробной информацией

---

## Схема работы платежей ЮКасса

### Для менеджера/промоутера:
1. Создается заявка на продажу (`sales` record со статусом `pending`)
2. Генерируется платежная ссылка/QR через API ЮКасса
3. Клиент оплачивает по ссылке/QR
4. Webhook от ЮКасса обновляет статус продажи

### Страница оплаты для клиента (публичная ссылка):
- Форма фиксирована, нельзя изменить количество билетов (заказ создан менеджером/промоутером)
- Показывает (только для просмотра, не редактируется): 
  - Количество взрослых билетов
  - Количество детских билетов (если есть в заказе)
  - Цена за 1 взрослый билет
  - Цена за 1 детский билет (если есть детские в заказе)
  - Общая сумма
- Поле для ввода email клиента (для отправки онлайн билета в PDF после подтверждения оплаты)
- Кнопка "Оплатить" (редирект на ЮКасса)
- Билеты (PDF) отправляются только после того, как ЮКасса подтвердила оплату (через webhook)

---

## API Endpoints (предварительно)

### Аутентификация
- `POST /api/auth/login` - вход в систему
  - Для промоутеров: `{ promoter_id: number, password: string }` (числовой ID)
  - Для остальных: `{ email: string, password: string }`
- `POST /api/auth/logout` - выход из системы
- `POST /api/auth/register/:token` - регистрация по пригласительной ссылке
  - Body: `{ full_name: string, phone: string, email: string, password: string, photo: File }`
  - Для промоутеров и менеджеров: фото лица обязательно (photo)
  - Проверяет токен приглашения и роль
- `GET /api/auth/verify-email/:token` - подтверждение email
  - После подтверждения промоутер получает `promoter_id` на почту
- `POST /api/auth/forgot-password` - запрос на восстановление пароля
  - Body: `{ email: string }` (отправляет токен на почту)
  - Для промоутеров: восстановление только по email (даже если входят по promoter_id)
- `POST /api/auth/reset-password` - восстановление пароля
  - Body: `{ token: string, new_password: string }`
- `GET /api/auth/me` - текущий пользователь (личный кабинет)

### Категории (владелец)
- `GET /api/categories` - список всех категорий (доступно всем для просмотра)
- `POST /api/categories` - создание категории (только владелец)
  - Body: `{ name: string }` (например: "Теплоход", "Катер")
  - Возвращает: созданную категорию
- `DELETE /api/categories/:id` - удаление категории (только владелец, если нет экскурсий в этой категории)
  - Можно удалить только если нет экскурсий в этой категории
  - Редактирование категории недоступно (ничего нельзя изменять после создания)

### Экскурсии
- `GET /api/tours` - список экскурсий
  - Query параметры: `?category_id=UUID` - фильтрация по категории
  - Query параметры: `?category_name=string` - поиск по названию категории
  - Query параметры: `?moderation_status=pending|approved|rejected` - фильтрация по статусу модерации (для владельца/партнера)
  - Менеджеры и промоутеры видят только одобренные экскурсии (`moderation_status = 'approved'`)
  - Владелец видит все экскурсии всех партнеров (все статусы модерации)
  - Партнер видит только свои экскурсии (все статусы модерации)
- `POST /api/tours` - создание (только партнер)
  - Body: `{ category_id: UUID, company: string, departure_time: DateTime, date: Date, max_places: number, partner_min_adult_price: number, partner_min_child_price: number, flight_number: string }`
  - `category_id` обязателен
  - Партнер устанавливает свои минимальные цены (`partner_min_adult_price`, `partner_min_child_price`)
  - После создания экскурсия автоматически переходит в статус модерации (`moderation_status = 'pending'`)
  - Владелец не может создавать экскурсии
- `POST /api/tours/:id/moderate` - модерация экскурсии (только владелец)
  - Body: `{ moderation_status: 'approved' | 'rejected', owner_min_adult_price: number, owner_min_child_price: number, commission_type: 'percentage' | 'fixed', commission_percentage?: number, commission_fixed_amount?: number }`
  - Устанавливает минимальные цены владельца, тип комиссии и её значение
  - После одобрения экскурсия становится видна для промоутеров и менеджеров
  - После модерации партнер не может ничего изменять
- `PATCH /api/tours/:id/min-prices` - изменение минимальных цен экскурсии (только владелец)
  - Body: `{ owner_min_adult_price: number, owner_min_child_price: number }`
  - Можно изменить даже если часть билетов уже продана
  - Доступно только для владельца
- `PATCH /api/tours/:id/commission` - изменение комиссии экскурсии (только владелец)
  - Body: `{ commission_type: 'percentage' | 'fixed', commission_percentage?: number, commission_fixed_amount?: number }`
  - Можно изменить даже если часть билетов уже продана
  - Доступно только для владельца
- `PATCH /api/tours/:id` - обновление экскурсии недоступно (партнер не может ничего изменять после создания)
  - Партнер не может изменять экскурсию после создания (только удалить, если нет проданных билетов)
  - Владелец может изменять только минимальные цены и комиссию через отдельные endpoints
- `PATCH /api/tours/:id/stop-sales` - остановка продаж (владелец/партнер для своих экскурсий)
- `DELETE /api/tours/:id` - удаление экскурсии (партнер для своих экскурсий)
  - Удаление возможно только если на экскурсию нет проданных билетов
  - Проверка: нет записей в таблице tickets со статусом `sold` или `used` для этой экскурсии
  - Возвращает ошибку, если есть проданные билеты
- `GET /api/tours/:id` - детали экскурсии

### Продажи
- `POST /api/sales` - создание продажи
- `GET /api/sales` - список продаж (с фильтрацией по ролям)
- `GET /api/sales/:id` - детали продажи
- `POST /api/sales/:id/upload-receipt` - загрузка фото чека (эквайринг)
- `POST /api/sales/:id/create-payment` - создание платежа ЮКасса
  - Возвращает QR и ссылку на страницу заказа (НЕ на оплату)
- `GET /api/sales/:id/payment-link/:token` - публичная страница заказа для клиента (с кнопкой оплаты)
- `POST /api/webhooks/yookassa` - webhook от ЮКасса для обновления статуса платежа
- `GET /api/promoters/check/:promoter_id` - проверка промоутера по ID (для менеджера при вводе ID промоутера)
  - Возвращает: `{ exists: boolean, full_name?: string }` (показывает ФИО если промоутер существует)

### Билеты
- `POST /api/tickets` - создание билета для продажи (наличка/эквайринг)
  - Body: `{ sale_id: UUID, ticket_number: 'AA00000000', photo: File }` (формат: 2 английские заглавные буквы + 8 цифр)
  - Создает один билет на всю продажу (adult_count и child_count берутся из sale)
  - Проверяет уникальность номера билета
- `GET /api/tickets/:id` - детали билета
  - Возвращает: информацию о билете, включая adult_count, child_count, статус, фото (если есть)
- `GET /api/tickets/:id/pdf` - генерация и скачивание PDF билета с QR (для онлайн билетов)
  - Генерирует один PDF для всего заказа
- `POST /api/tickets/:id/cancel` - отмена билета (только владелец)
  - Отменяет билет (статус меняется на `cancelled` и остается в этом статусе)
  - Записывает время отмены (`cancelled_at`) и кто отменил (`cancelled_by_user_id`)
  - Места в экскурсии освобождаются (current_booked_places уменьшается на количество мест в билете: adult_count + child_count)
  - Если экскурсия была с остановленными продажами из-за заполнения мест, продажи могут возобновиться автоматически
  - **Обновляет баланс "Должен компании"** у менеджера (если оплата была наличкой/эквайрингом):
    - Если билет был продан менеджером за себя наличкой/эквайрингом → баланс "Должен компании" (`debt_to_company`) пополняется на полную сумму билета
    - Если билет был продан менеджером за промоутера наличкой/эквайрингом → баланс "Должен компании" (`debt_to_company`) у менеджера пополняется на полную сумму билета
    - Сумма пополнения долга = `total_amount` из продажи (adult_price × adult_count + child_price × child_count)
    - Обычный баланс (`balance`) при отмене не изменяется (пополняется только при статусе `used`)
  - Возвращает: `{ success: boolean, message: string }`
- `GET /api/tickets/check/qr/:qr_data` - получение информации о билете по QR коду (для контролера)
  - Возвращает: `{ ticket: { id, tour: { name, date, departure_time, ... }, adult_count, child_count, status, used_at, used_by_user_id, ... }, is_valid: boolean, can_confirm: boolean, message: string }`
  - `can_confirm: true` если статус `sold` (можно подтвердить), `false` если статус `used` или `cancelled` (уже использован/отменен)
  - `message` содержит "Билет уже использован" если `status === 'used'` или "Билет отменен" если `status === 'cancelled'`
  - НЕ обновляет статус, только показывает информацию
  - Доступно для `partner` (основной профиль) и `partner_controller` (альтернативный профиль)
- `POST /api/tickets/:id/confirm` - подтверждение использования билета (для контролера)
  - Проверяет, что статус билета `sold` (нельзя подтвердить уже использованный/отмененный билет)
  - Если статус `used` или `cancelled` → возвращает ошибку: `{ success: false, message: "Билет уже использован/отменен" }`
  - Если статус `sold` → обновляет статус на `used` (Использовано)
  - Записывает время использования и контролера
  - **Обновляет балансы** у продавца билета:
    - Определяется продавец и тип комиссии экскурсии
    - Если билет был продан менеджером за себя:
      - Баланс менеджера (`balance`) пополняется на процент/фиксированную сумму от продажи
      - Если оплата наличкой/эквайрингом → баланс "Должен компании" (`debt_to_company`) пополняется на полную сумму билета
    - Если билет был продан промоутером:
      - Баланс промоутера (`balance`) пополняется на процент/фиксированную сумму от продажи
    - Если билет был продан менеджером за промоутера:
      - Баланс промоутера (`balance`) пополняется на процент/фиксированную сумму от продажи
      - Если оплата наличкой/эквайрингом → баланс "Должен компании" (`debt_to_company`) у менеджера пополняется на полную сумму билета
    - Сумма пополнения баланса:
      - Если `commission_type = 'percentage'`: `total_amount` × `commission_percentage` / 100
      - Если `commission_type = 'fixed'`: `commission_fixed_amount`
    - Сумма пополнения долга = `total_amount` из продажи (adult_price × adult_count + child_price × child_count)
  - Возвращает: `{ success: boolean, message: string }`
  - Доступно для `partner` (основной профиль) и `partner_controller` (альтернативный профиль)
- `POST /api/tickets/check/number` - получение информации о билете по номеру (для контролера)
  - Body: `{ ticket_number: 'AA00000000' }` (формат: 2 английские заглавные буквы + 8 цифр)
  - Возвращает: `{ ticket: { id, tour: { name, date, departure_time, ... }, adult_count, child_count, status, photo_url, used_at, used_by_user_id, cancelled_at, cancelled_by_user_id, ... }, is_valid: boolean, can_confirm: boolean, message: string }`
  - `can_confirm: true` если статус `sold` (можно подтвердить), `false` если статус `used` или `cancelled` (уже использован/отменен)
  - `message` содержит "Билет уже использован" если `status === 'used'` или "Билет отменен" если `status === 'cancelled'`
  - НЕ обновляет статус, только показывает информацию
  - Доступно для `partner` (основной профиль) и `partner_controller` (альтернативный профиль)
- `GET /api/tickets` - список билетов (с фильтрацией по статусу, экскурсии, продавцу)

### Приглашения (владелец, менеджер)
- `POST /api/invitations` - создание пригласительной ссылки
  - Владелец: может приглашать менеджеров, промоутеров, партнеров
  - Менеджер: может приглашать только промоутеров
  - Body: `{ target_role: 'manager' | 'promoter' | 'partner' }`
  - Срок действия автоматически: 1 сутки (24 часа)
  - Возвращает: `{ invitation_link: string, token: string, expires_at: DateTime }`
- `GET /api/invitations` - список приглашений (созданных текущим пользователем)
- `DELETE /api/invitations/:id` - отозвать неиспользованное приглашение

### Настройки партнера (основной профиль)
- `POST /api/partner/create-controller` - создание альтернативного профиля контролера
  - Body: `{ password: string }`
  - Создает контролера с тем же email, но отдельным паролем
  - Доступно только для основного профиля партнера
- `POST /api/partner/controller-password` - изменение пароля альтернативного профиля контролера
  - Body: `{ new_password: string }`
  - Изменяет пароль альтернативного профиля (связанного через `main_partner_id`)
  - Доступно только для основного профиля партнера (если контролер уже создан)

### Выдача вещей (владелец, помощник владельца)
- `POST /api/issued-items` - выдача вещи промоутеру или менеджеру
  - Body: `{ user_identifier: string, item_name: string, item_description?: string, photo: File }`
  - Поиск промоутера: только по `promoter_id` (числовой ID)
  - Поиск менеджера: только по email
  - Название вещи - свободный ввод (например: кофта, эквайринг)
  - Прикрепление фото выданной вещи (обязательно)
  - Автоматическое сжатие фото при загрузке
  - Можно выдавать неограниченное количество вещей
  - Только просмотр и удаление выданных вещей (редактирование недоступно)
  - Доступно для `owner` (владелец) и `owner_assistant` (помощник владельца)
- `GET /api/issued-items` - список выданных вещей (для владельца и помощника)
  - Возвращает историю всех выданных вещей с фото
  - Фильтрация не требуется
- `GET /api/issued-items/my-items` - список вещей, выданных текущему пользователю (для промоутера/менеджера)
  - Показывает раздел с выданными вещами в ЛК
  - Возвращает: название вещи, описание, фото, дату выдачи
- `DELETE /api/issued-items/:id` - убрать вещь у промоутера/менеджера
  - Помечает вещь как возвращенную (`is_returned = true`)
  - Записывает время возврата и кто убрал вещь
  - Поиск промоутера: только по `promoter_id`, менеджера: только по email
  - Доступно для `owner` (владелец) и `owner_assistant` (помощник владельца)

### Настройки владельца
- `POST /api/owner/create-assistant` - создание помощника владельца
  - Body: `{ password: string }`
  - Создает помощника с тем же email, но отдельным паролем
  - Доступно только для владельца
- `POST /api/owner/assistant-password` - изменение пароля помощника владельца
  - Body: `{ new_password: string }`
  - Изменяет пароль помощника владельца (связанного через `main_owner_id`)
  - Доступно только для владельца (если помощник уже создан)

### Статистика (владелец)
- `GET /api/statistics/overview` - общая статистика
- `GET /api/statistics/by-tour` - по экскурсиям
- `GET /api/statistics/by-seller` - по продавцам
- `GET /api/statistics/by-payment-method` - по способам оплаты
- `GET /api/statistics/by-partner/:partner_id` - статистика по конкретному партнеру
- `GET /api/statistics/by-user/:user_id` - статистика по конкретному менеджеру/промоутеру
- `GET /api/statistics/export` - экспорт статистики в Excel
  - Query параметры для фильтрации (по датам, партнерам, продавцам и т.д.)

### Управление пользователями (владелец)
- `GET /api/users` - список всех пользователей (промоутеры, менеджеры, партнеры)
  - Возвращает: список с информацией о пользователях
- `GET /api/users/promoters` - список промоутеров с их балансами
  - Возвращает: `[{ id, promoter_id, full_name, balance, is_active, ... }]`
- `GET /api/users/managers` - список менеджеров с их балансами и балансами "Должен компании"
  - Возвращает: `[{ id, email, full_name, balance, debt_to_company, is_active, ... }]`
- `GET /api/users/:id` - детальная информация о пользователе
  - Возвращает: продажи, выданные вещи, статистику, баланс(ы), фото лица (для промоутеров/менеджеров)
- `GET /api/users/:id/balance-history` - история баланса пользователя (для промоутера/менеджера)
  - Возвращает историю пополнений и обнулений баланса
  - Query параметры: `?balance_type=balance|debt_to_company` - фильтрация по типу баланса
  - Query параметры: `?transaction_type=credit|debit` - фильтрация по типу операции (пополнение/выплата)
  - Возвращает: `[{ id, balance_type, transaction_type, amount, balance_before, balance_after, description, ticket_id, sale_id, performed_by_user_id, created_at, ... }]`
- `GET /api/users/me/balance-history` - история баланса текущего пользователя (для промоутера/менеджера в личном кабинете)
  - Возвращает историю пополнений и обнулений баланса текущего пользователя
  - Query параметры: `?balance_type=balance|debt_to_company` - фильтрация по типу баланса
  - Query параметры: `?transaction_type=credit|debit` - фильтрация по типу операции
  - Возвращает: `[{ id, balance_type, transaction_type, amount, balance_before, balance_after, description, ticket_id, sale_id, performed_by_user_id, created_at, ... }]`
- `PATCH /api/users/:id/status` - блокировка/разблокировка пользователя
  - Body: `{ is_active: boolean }`
  - Доступно только для владельца
- `POST /api/users/:id/reset-balance` - обнуление баланса у промоутера/менеджера
  - Body: `{}`
  - Обнуляет `balance` у пользователя (устанавливает в 0)
  - Обнуляет только текущий баланс (сумму билетов в статусе `used` на момент обнуления)
  - Билеты в статусе `sold` не учитываются (они еще не были засчитаны в баланс)
  - После обнуления, если новые билеты перейдут из `sold` в `used`, баланс будет накапливаться с нуля
  - **Записывает историю баланса** (`balance_history`):
    - Тип: `balance`
    - Операция: `debit` (обнуление/выплата)
    - Сумма: сумма обнуленного баланса
    - Описание: "Выплата владельцем, баланс обнулен"
    - Баланс до и после операции (после = 0)
    - Кто выполнил операцию (`performed_by_user_id` - владелец)
  - Доступно только для владельца
  - Доступно через личный кабинет владельца (список промоутеров/менеджеров с балансами)
- `POST /api/users/:id/reset-debt` - обнуление баланса "Должен компании" у менеджера
  - Body: `{}`
  - Обнуляет `debt_to_company` у менеджера (устанавливает в 0)
  - **Записывает историю баланса** (`balance_history`):
    - Тип: `debt_to_company`
    - Операция: `debit` (обнуление/выплата)
    - Сумма: сумма обнуленного долга
    - Описание: "Выплата владельцем, долг обнулен"
    - Баланс до и после операции (после = 0)
    - Кто выполнил операцию (`performed_by_user_id` - владелец)
  - Доступно только для владельца
  - Доступно только для менеджеров

---

## Технологический стек (предложение)

### Backend:
- **Node.js** + **Express** или **Next.js API Routes**
- **PostgreSQL** или **Prisma** + PostgreSQL
- **JWT** для аутентификации
- **Multer** для загрузки фото
- **YooKassa SDK** для платежей

### Frontend:
- **Next.js** (React) с TypeScript
- **Tailwind CSS** для стилей
- **React Hook Form** для форм
- **Zustand** или **Redux** для состояния
- **QR Code library** для генерации QR

### Инфраструктура:
- **Supabase** (если используем) или собственная БД
- **Хранение файлов**: на сервере (фото билетов/чеков, PDF билеты, логотип)
  - Фото билетов/чеков хранятся на сервере
  - PDF билеты хранятся на сервере
  - Логотип компании хранится в папке проекта (добавится позже, используется для генерации PDF)
  - Автоматическое сжатие фото при загрузке
- **PDF генерация**: библиотека для создания PDF (pdfkit, puppeteer, или jsPDF)
  - Красивый дизайн с использованием логотипа из папки проекта
  - Возможность изменять логотип через интерфейс не требуется
- **QR генерация**: библиотека для QR кодов (qrcode)
- **Email отправка**: **mail.ru SMTP** для отправки PDF билетов, подтверждений, промоутер ID
  - Используется через Nodemailer с настройкой SMTP mail.ru
- **Экспорт данных**: библиотека для экспорта в Excel (xlsx, exceljs)
- **Собственный сервер** для деплоя (хранение файлов на сервере)

---

## Потоки работы

### Поток 1: Менеджер продает онлайн
1. Менеджер выбирает экскурсию
2. Указывает количество взрослых/детей, цены (≥ минимальных)
3. Выбирает "Онлайн оплата"
4. Система создает:
   - Продажу (sale) со статусом pending
   - Публичную страницу заказа с токеном (payment_link_token)
   - QR код и ссылку, которые ведут на эту страницу (НЕ на оплату напрямую)
5. Менеджеру показывается QR и ссылка на страницу заказа (НЕ на оплату)
6. Менеджер показывает QR клиенту или отправляет ссылку
7. Клиент открывает ссылку/сканирует QR → видит страницу с заказом:
   - Количество взрослых билетов
   - Количество детских билетов (только если есть детские в заказе)
   - Цена за 1 взрослый билет
   - Цена за 1 детский билет (только если есть детские в заказе)
   - Общая сумма
   - Поле для ввода email
   - Кнопку "Оплатить" (редирект на ЮКасса)
8. Клиент вводит email и нажимает "Оплатить"
9. Клиент оплачивает через ЮКасса
10. После успешной оплаты (подтверждение через webhook от ЮКасса):
    - Webhook от ЮКасса обновляет статус продажи (payment_status = completed)
    - **Только после подтверждения оплаты** создается один билет в таблице tickets:
      - adult_count = количество взрослых из продажи
      - child_count = количество детских из продажи
      - ticket_status = `sold` (Продано)
    - **Только после подтверждения оплаты** генерируется один QR код (ведет на публичную страницу с информацией о билете)
    - **Только после подтверждения оплаты** генерируется один PDF билет с QR (содержит всю информацию о заказе)
    - **Только после подтверждения оплаты** PDF отправляется на email клиента
    - Места в экскурсии уменьшаются: current_booked_places += (adult_count + child_count)
    - Если места закончились → автоматический стоп продаж

### Поток 2: Менеджер продает наличкой
1. Менеджер выбирает экскурсию
2. Указывает количество взрослых/детей, цены
3. Опционально вводит ID промоутера (если промоутер попросил) → система проверяет ID и показывает ФИО промоутера
4. Выбирает "Наличные"
5. Система запрашивает:
   - Один номер билета в формате `AA00000000` (2 английские заглавные буквы + 8 цифр) на весь заказ
   - Одно фото пронумерованного бумажного билета
6. Менеджер вводит номер билета вручную и загружает одно фото (билеты уже есть физически, генерация не требуется)
   - Пример: билет AB12345678 с указанием "2 взрослых, 1 детский"
7. Система проверяет уникальность номера билета и валидацию формата (2 заглавные буквы + 8 цифр)
8. Создается один билет в таблице tickets:
   - ticket_number = введенный номер
   - ticket_photo_url = загруженное фото
   - adult_count = количество взрослых из продажи
   - child_count = количество детских из продажи
   - ticket_status = `sold` (Продано)
9. Продажа помечается как завершенной (payment_status = completed)
10. Записывается на промоутера (если указан ID и промоутер существует), иначе на менеджера
11. Места в экскурсии уменьшаются: current_booked_places += (adult_count + child_count)
12. Если места закончились → автоматический стоп продаж

### Поток 3: Менеджер продает эквайрингом
1. Менеджер выбирает экскурсию
2. Указывает количество взрослых/детей, цены
3. Опционально вводит ID промоутера (если промоутер попросил) → система проверяет ID и показывает ФИО промоутера
4. Выбирает "Эквайринг"
5. Система запрашивает фото чека эквайринга
6. Менеджер загружает фото чека
7. Система запрашивает:
   - Один номер билета в формате `AA00000000` (2 английские заглавные буквы + 8 цифр) на весь заказ
   - Одно фото пронумерованного бумажного билета
8. Менеджер вводит номер билета вручную и загружает одно фото (билеты уже есть физически, генерация не требуется)
9. Система проверяет уникальность номера билета
10. Создается один билет в таблице tickets:
    - ticket_number = введенный номер
    - ticket_photo_url = загруженное фото
    - adult_count = количество взрослых из продажи
    - child_count = количество детских из продажи
    - ticket_status = `sold` (Продано)
11. Продажа помечается как завершенной (payment_status = completed)
12. Записывается на промоутера (если указан ID и промоутер существует), иначе на менеджера
13. Места в экскурсии уменьшаются: current_booked_places += (adult_count + child_count)
14. Если места закончились → автоматический стоп продаж

### Поток 4: Промоутер продает онлайн
1. Промоутер выбирает экскурсию
2. Указывает количество взрослых/детей, цены (≥ минимальных)
3. Выбирает "Онлайн оплата"
4. Система создает:
   - Продажу (sale) со статусом pending
   - Публичную страницу заказа с токеном (payment_link_token)
   - QR код и ссылку, которые ведут на эту страницу (НЕ на оплату напрямую)
5. Промоутеру показывается QR и ссылка на страницу заказа (НЕ на оплату)
6. Промоутер показывает QR клиенту или отправляет ссылку
7. Клиент открывает ссылку/сканирует QR → видит страницу с заказом:
   - Количество взрослых билетов
   - Количество детских билетов (только если есть детские в заказе)
   - Цена за 1 взрослый билет
   - Цена за 1 детский билет (только если есть детские в заказе)
   - Общая сумма
   - Поле для ввода email
   - Кнопку "Оплатить" (редирект на ЮКасса)
8. Клиент вводит email и нажимает "Оплатить"
9. Клиент оплачивает через ЮКасса
10. После успешной оплаты (подтверждение через webhook от ЮКасса):
    - Webhook от ЮКасса обновляет статус продажи (payment_status = completed)
    - **Только после подтверждения оплаты** создается один билет в таблице tickets:
      - adult_count = количество взрослых из продажи
      - child_count = количество детских из продажи
      - ticket_status = `sold` (Продано)
    - **Только после подтверждения оплаты** генерируется один QR код (ведет на публичную страницу с информацией о билете)
    - **Только после подтверждения оплаты** генерируется один PDF билет с QR (содержит всю информацию о заказе)
    - **Только после подтверждения оплаты** PDF отправляется на email клиента
    - Места в экскурсии уменьшаются: current_booked_places += (adult_count + child_count)
    - Если места закончились → автоматический стоп продаж

### Поток 5: Проверка билета на входе (Партнер)
1. Партнер (основной профиль) или контролер (альтернативный профиль партнера) входит в систему:
   - Основной профиль: email + пароль основного профиля
   - Альтернативный профиль: email + пароль контролера (тот же email, но другой пароль)
2. Открывается страница проверки билетов:
   - Основной профиль партнера: имеет доступ ко всем функциям + проверка билетов
   - Альтернативный профиль: доступ только к проверке билетов, без других функций
3. Проверка электронного билета (онлайн оплата):
   - Контролер сканирует QR код билета (один QR на весь заказ)
   - Система находит билет по QR данным
   - **Если билет со статусом `sold` (Продано):**
     - Показывает информацию о билете:
       - На какую экскурсию куплен билет (название, дата, время отправления)
       - Количество взрослых мест (например: "2 взрослых")
       - Количество детских мест (например: "1 детский", только если `child_count > 0`)
       - Статус билета: "Продано"
     - Проверяет соответствие экскурсии и даты
     - Показываются кнопки:
       - "Подтвердить" - при нажатии:
         - Статус билета меняется на `used` (Использовано)
         - Записывается время использования (`used_at`)
         - Записывается контролер (`used_by_user_id`)
         - Показывается подтверждение успешной проверки
       - "Отмена" - при нажатии:
         - Статус билета остается `sold` (Продано)
         - Информация не сохраняется
         - Возврат на страницу проверки
   - **Если билет со статусом `used` (Использовано) - повторное сканирование:**
     - Показывает информацию о билете:
       - На какую экскурсию куплен билет (название, дата, время отправления)
       - Количество взрослых мест
       - Количество детских мест (если есть)
       - Статус билета: "Использовано"
       - Время использования (`used_at`)
       - Кто проверил билет (`used_by_user_id`)
     - **Показывается сообщение: "Билет уже использован"** (выделенное предупреждение/ошибка)
     - Кнопки "Подтвердить" и "Отмена" не показываются (или показывается только кнопка "Закрыть")
     - Билет не может быть подтвержден повторно
4. Проверка бумажного билета (наличка/эквайринг):
   - Контролер вводит номер билета в формате `AA00000000` (2 английские заглавные буквы + 8 цифр, один номер на весь заказ)
   - Система находит билет по номеру
   - **Если билет со статусом `sold` (Продано):**
     - Показывает информацию о билете:
       - На какую экскурсию куплен билет (название, дата, время отправления)
       - Количество взрослых мест (например: "2 взрослых")
       - Количество детских мест (например: "1 детский", только если `child_count > 0`)
       - Статус билета: "Продано"
       - Фото билета для сверки (если есть)
     - Проверяет соответствие экскурсии и даты
     - Показываются кнопки:
       - "Подтвердить" - при нажатии:
         - Статус билета меняется на `used` (Использовано)
         - Записывается время использования (`used_at`)
         - Записывается контролер (`used_by_user_id`)
         - Показывается подтверждение успешной проверки
       - "Отмена" - при нажатии:
         - Статус билета остается `sold` (Продано)
         - Информация не сохраняется
         - Возврат на страницу проверки
   - **Если билет со статусом `used` (Использовано) - повторный ввод номера:**
     - Показывает информацию о билете:
       - На какую экскурсию куплен билет (название, дата, время отправления)
       - Количество взрослых мест
       - Количество детских мест (если есть)
       - Статус билета: "Использовано"
       - Фото билета для сверки (если есть)
       - Время использования (`used_at`)
       - Кто проверил билет (`used_by_user_id`)
     - **Показывается сообщение: "Билет уже использован"** (выделенное предупреждение/ошибка)
     - Кнопки "Подтвердить" и "Отмена" не показываются (или показывается только кнопка "Закрыть")
     - Билет не может быть подтвержден повторно

---

## Детали реализации

### Категории экскурсий
- Категории создает только владелец (например: "Теплоход", "Катер", "Автобус")
- При создании экскурсии обязательно выбирается категория
- Категории используются для:
  - Фильтрации экскурсий (менеджеры и промоутеры могут искать по категории)
  - Группировки экскурсий в списках
  - Поиска экскурсий по названию категории
- Категория не может быть удалена, если есть экскурсии в этой категории
- Редактирование категорий недоступно (ничего нельзя изменять после создания)

### Модерация экскурсий
- Партнер создает экскурсию и устанавливает свои минимальные цены (`partner_min_adult_price`, `partner_min_child_price`)
- После создания экскурсия автоматически переходит в статус модерации (`moderation_status = 'pending'`)
- Пока экскурсия не прошла модерацию:
  - Она не отображается у промоутеров и менеджеров
  - На неё нельзя продать билеты
- Владелец модерирует экскурсию:
  - Устанавливает минимальные цены владельца (`owner_min_adult_price`, `owner_min_child_price`)
  - Устанавливает тип комиссии (процент или фиксированная сумма) и её значение
  - Одобряет или отклоняет экскурсию
- После модерации партнер не может ничего изменять в экскурсии
- Владелец может изменять минимальные цены и комиссию даже если часть билетов уже продана

### Редактирование экскурсий
- После создания экскурсии редактирование параметров недоступно:
  - Нельзя изменять дату экскурсии
  - Нельзя изменять время отправления
  - Нельзя изменять максимальное количество мест
  - Нельзя изменять компанию
  - Нельзя изменять рейс
  - Нельзя изменять категорию
- Партнер не может ничего изменять после создания (только удалить, если нет проданных билетов)
- Владелец может изменять только минимальные цены и комиссию:
  - Минимальные цены: через endpoint `PATCH /api/tours/:id/min-prices`
  - Комиссия: через endpoint `PATCH /api/tours/:id/commission`
  - Можно изменить даже если часть билетов уже продана

### Удаление экскурсий
- Владелец может удалить любую экскурсию
- Партнер может удалить только свои экскурсии
- Удаление возможно только если на экскурсию нет проданных билетов
- Проверка при удалении:
  - Нет записей в таблице `tickets` со статусом `sold` или `used` для данной экскурсии
  - Если есть проданные билеты → возвращается ошибка с сообщением "Нельзя удалить экскурсию с проданными билетами"
- После удаления экскурсии все связанные записи в таблице `sales` (со статусом `pending`) также удаляются
- Билеты с проданными билетами нельзя удалить (нужно сначала отменить продажи или дождаться использования всех билетов)

### PDF билет с QR для контроля (онлайн оплата)
После успешной онлайн оплаты (только после подтверждения оплаты через webhook от ЮКасса):
- Генерируется один PDF билет на весь заказ
- PDF содержит:
  - **Красивый дизайн** с использованием логотипа компании (логотип добавляется в папку проекта)
  - Информацию об экскурсии (дата, время отправления, компания, рейс)
  - Количество взрослых мест (всегда показывается)
  - Количество детских мест (показывается только если `child_count > 0`)
  - Цены и общую сумму:
    - Цена за взрослый билет × количество
    - Цена за детский билет × количество (только если `child_count > 0`)
  - Уникальный QR-код для контроля на входе (ведет на публичную страницу с информацией о билете)
  - Номер билета (UUID или другой уникальный идентификатор)
  - Брендирование и логотип компании
- PDF отправляется на email клиента только после подтверждения оплаты ЮКассой

### Билеты при наличке/эквайринге
- Билеты уже есть физически, менеджер вводит номер сам (генерация не требуется)
- Менеджер вводит один номер билета в формате `AA00000000` (2 английские заглавные буквы + 8 цифр) на весь заказ
- Номер билета должен быть уникальным в системе
- Валидация формата на фронтенде (2 заглавные буквы + 8 цифр)
- Менеджер загружает одно фото пронумерованного бумажного билета (в котором указано количество взрослых и детских мест)
- На входе проверяется номер билета (ввод номера или сканирование с фото) - проверяется весь заказ целиком

### Отмена билетов владельцем
- Владелец может отменить любой билет через API endpoint `POST /api/tickets/:id/cancel`
- При отмене билета:
  - Статус меняется на `cancelled` (Отменено)
  - Записывается время отмены (`cancelled_at`)
  - Записывается кто отменил (`cancelled_by_user_id` - владелец)
  - Статус остается `cancelled` и не переходит в `used` (остается отмененным)
  - **Места в экскурсии освобождаются**: `current_booked_places` уменьшается на количество мест в билете (adult_count + child_count)
  - Если экскурсия была с остановленными продажами из-за заполнения мест, продажи могут возобновиться автоматически (если `current_booked_places < max_places`)
- Отмененный билет не может быть подтвержден на входе (статус `cancelled`)

### Выдача вещей промоутерам и менеджерам
- Владелец и помощник владельца могут выдавать вещи промоутерам и менеджерам
- Процесс выдачи:
  1. Поиск промоутера/менеджера по ID (для промоутера можно искать по `promoter_id`)
  2. Указание названия вещи (свободный ввод, например: кофта, эквайринг)
  3. Опциональное описание вещи
  4. Прикрепление фото выданной вещи (обязательно)
  5. Выдача вещи (создается запись в таблице `issued_items`)
- Можно выдавать неограниченное количество вещей одному промоутеру/менеджеру
- В личном кабинете промоутера и менеджера есть раздел "Выданные вещи":
  - Показывается список всех выданных вещей (которые не возвращены: `is_returned = false`)
  - Для каждой вещи показывается: название, описание, фото, дата выдачи
- Владелец и помощник могут убрать вещь:
  - Поиск промоутера/менеджера по ID
  - Выбор вещи из списка выданных
  - Удаление/возврат вещи (статус меняется на `is_returned = true`)
- История выданных вещей:
  - Владелец видит полную историю всех выданных вещей с фото
  - История включает как текущие выданные вещи, так и возвращенные
  - Для каждой вещи сохраняется фото даже после возврата

### Система балансов промоутеров и менеджеров
- У каждого промоутера и менеджера есть поле `balance` (баланс)
- У каждого менеджера есть отдельное поле `debt_to_company` (баланс "Должен компании")
- **Баланс (`balance`) пополняется только когда билет переходит из статуса `sold` (Продано) в `used` (Использовано)**
- **Баланс "Должен компании" (`debt_to_company`) пополняется при статусе `used` или `cancelled`** (только для менеджеров при наличке/эквайринге)

#### Обновление баланса (`balance`) при подтверждении билета (`POST /api/tickets/:id/confirm`):
  - Определяется продавец билета и тип комиссии экскурсии
  - Сумма пополнения баланса:
    - Если `commission_type = 'percentage'`: `total_amount` × `commission_percentage` / 100
    - Если `commission_type = 'fixed'`: `commission_fixed_amount`
  - **Записывается история баланса** (`balance_history`):
    - Тип: `balance`
    - Операция: `credit` (пополнение)
    - Сумма: рассчитанная сумма комиссии
    - Описание: "Пополнение от продажи билета #ticket_id, сумма продажи: total_amount₽, комиссия: amount₽"
    - Баланс до и после операции
    - Связь с билетом (`ticket_id`) и продажей (`sale_id`)
- Примеры:
  - Промоутер продал билет за 1 000₽, процент 20% → баланс пополняется на 200₽ (только при статусе `used`)
  - Менеджер продал билет за 1 000₽, процент 20% → баланс пополняется на 200₽ (только при статусе `used`)
  - Менеджер продал билет за 1 000₽, фиксированная сумма 150₽ → баланс пополняется на 150₽ (только при статусе `used`)

#### Обновление баланса "Должен компании" (`debt_to_company`) для менеджеров:
**При продаже за наличку за себя:**
- Баланс (`balance`) пополняется на процент/фиксированную сумму от продажи (только при статусе `used`)
- Баланс "Должен компании" (`debt_to_company`) пополняется на полную сумму билета (при статусе `used` или `cancelled`)
- **Записывается история баланса** для обоих типов балансов:
  - Для баланса (`balance`): тип `balance`, операция `credit`, описание "Пополнение от продажи билета #ticket_id, сумма продажи: total_amount₽, комиссия: amount₽"
  - Для долга (`debt_to_company`): тип `debt_to_company`, операция `credit`, описание "Пополнение долга от продажи билета #ticket_id за наличку, сумма: total_amount₽"
- Пример: продажа на 1 000₽, процент 20%
  - Баланс пополняется на 200₽ (при статусе `used`)
  - Баланс "Должен компании" пополняется на 1 000₽ (при статусе `used` или `cancelled`)
  - История: запись о пополнении баланса (200₽) и запись о пополнении долга (1 000₽)

**При продаже за наличку за промоутера:**
- Баланс промоутера (`balance`) пополняется на процент/фиксированную сумму от продажи (только при статусе `used`)
- Баланс "Должен компании" (`debt_to_company`) у менеджера пополняется на полную сумму билета (при статусе `used` или `cancelled`)
- **Записывается история баланса** для обоих пользователей:
  - Для баланса промоутера: тип `balance`, операция `credit`, описание "Пополнение от продажи билета #ticket_id за промоутера, сумма продажи: total_amount₽, комиссия: amount₽"
  - Для долга менеджера: тип `debt_to_company`, операция `credit`, описание "Пополнение долга от продажи билета #ticket_id за промоутера наличкой, сумма: total_amount₽"
- Пример: менеджер продал за промоутера на 1 000₽, процент 20%
  - Баланс промоутера пополняется на 200₽ (при статусе `used`)
  - Баланс "Должен компании" у менеджера пополняется на 1 000₽ (при статусе `used` или `cancelled`)
  - История: запись о пополнении баланса промоутера (200₽) и запись о пополнении долга менеджера (1 000₽)

#### Обновление баланса "Должен компании" при отмене билета (`POST /api/tickets/:id/cancel`):
- Если билет был продан менеджером за себя наличкой/эквайрингом:
  - Баланс "Должен компании" (`debt_to_company`) пополняется на полную сумму билета
  - Обычный баланс (`balance`) не изменяется (пополняется только при статусе `used`)
  - **Записывается история баланса**: тип `debt_to_company`, операция `credit`, описание "Пополнение долга от отмененного билета #ticket_id за наличку, сумма: total_amount₽"
- Если билет был продан менеджером за промоутера наличкой/эквайрингом:
  - Баланс "Должен компании" (`debt_to_company`) у менеджера пополняется на полную сумму билета
  - Баланс промоутера не изменяется
  - **Записывается история баланса**: тип `debt_to_company`, операция `credit`, описание "Пополнение долга от отмененного билета #ticket_id за промоутера наличкой, сумма: total_amount₽"

#### Обнуление балансов владельцем:
- Владелец может обнулить баланс (`balance`) через `POST /api/users/:id/reset-balance`
- Владелец может обнулить баланс "Должен компании" (`debt_to_company`) через `POST /api/users/:id/reset-debt` (только для менеджеров)
- Обнуляется только текущий баланс (сумма билетов в статусе `used` или `cancelled` на момент обнуления)
- Билеты в статусе `sold` не учитываются (они еще не были засчитаны)
- После обнуления, если новые билеты перейдут из `sold` в `used`, баланс будет накапливаться с нуля
- **Записывается история баланса** при каждом обнулении:
  - Тип: `balance` или `debt_to_company`
  - Операция: `debit` (обнуление/выплата)
  - Сумма: сумма обнуленного баланса
  - Описание: "Выплата владельцем, баланс обнулен"
  - Баланс до и после операции (после = 0)
  - Кто выполнил операцию (`performed_by_user_id` - владелец)

#### Пример работы балансов:
- Промоутер продал 2 билета за 1 000₽ каждый, процент 20%
  - Билеты в статусе `sold` → `balance` = 0₽ (билеты еще не засчитаны)
  - Первый билет проверен на входе (статус `used`) → `balance` = 200₽
  - Второй билет проверен на входе (статус `used`) → `balance` = 400₽

- Менеджер продал за наличку за себя билет за 1 000₽, процент 20%
  - Билет в статусе `sold` → `balance` = 0₽, `debt_to_company` = 0₽
  - Билет проверен на входе (статус `used`) → `balance` = 200₽, `debt_to_company` = 1 000₽
  - Если билет отменен (статус `cancelled`) → `balance` = 0₽, `debt_to_company` = 1 000₽

- В личном кабинете промоутера/менеджера показывается текущий баланс (только билеты в статусе `used`)
- В личном кабинете менеджера показывается баланс "Должен компании" (билеты в статусе `used` или `cancelled`)

### Заполнение мест
- Считаются только **оплаченные** билеты (payment_status = 'completed' в таблице sales)
- Места считаются по билетам со статусом `sold` в таблице tickets
- При каждой завершенной продаже создается один билет (ticket) со статусом `sold`
- `current_booked_places` = сумма (adult_count + child_count) всех билетов со статусом `sold` для данной экскурсии
  - Пример: билет с `adult_count=2, child_count=0` → добавляет 2 места
  - Пример: билет с `adult_count=2, child_count=1` → добавляет 3 места
- Если `current_booked_places >= max_places` → автоматически `is_sale_stopped = true`
- При проверке билета на входе (статус меняется на `used`) места не освобождаются (билет использован, но место занято)
  - **НО баланс обновляется** (добавляется к `balance` продавца, а для менеджеров при наличке/эквайринге также обновляется `debt_to_company`)
- При отмене билета владельцем (статус меняется на `cancelled`) места освобождаются (current_booked_places уменьшается на adult_count + child_count)
- Один билет = один заказ (может содержать несколько мест: adult_count + child_count, где child_count может быть 0)

### Платформа
- Пока только **web-версия** (десктоп и мобильный браузер)
- Мобильное приложение для владельца - в будущем (пока не нужно)

---

## Процесс регистрации

### Создание владельца:
1. Владелец создается изначально при установке системы (единственный владелец)
2. При создании владельца заполняются:
   - Email, пароль для основного профиля
3. Владелец (основной профиль) может войти по **email + пароль**
4. **Помощник владельца создается владельцем через ЛК:**
   - Владелец заходит в раздел Настройки
   - Создает помощника с указанием пароля
   - Помощник получает ту же почту (email), но отдельный пароль
   - Роль: `owner_assistant`
   - Связь с основным профилем через `main_owner_id`
5. Помощник владельца (альтернативный профиль) может войти по **email + пароль помощника**
6. Пароль помощника владельца можно изменить в настройках владельца (после создания)

### Регистрация менеджера:
1. Владелец создает пригласительную ссылку для менеджера
2. Менеджер переходит по ссылке → открывается форма регистрации
3. Менеджер заполняет: ФИО, номер телефона, email, пароль
4. Система отправляет письмо с подтверждением email
5. Менеджер подтверждает email
6. Менеджер может войти по **email + пароль**

### Регистрация промоутера:
1. Владелец или менеджер создает пригласительную ссылку для промоутера
2. Промоутер переходит по ссылке → открывается форма регистрации
3. Промоутер заполняет: ФИО, номер телефона, email, пароль
4. **Промоутер обязательно прикладывает свою фотографию лица** (обязательное поле)
5. Система отправляет письмо с подтверждением email
6. Промоутер подтверждает email
7. Система генерирует уникальный числовой **promoter_id** для промоутера
8. Система отправляет письмо с **promoter_id** на email промоутера
9. **promoter_id** также показывается в личном кабинете промоутера
10. Промоутер может войти по **promoter_id + пароль**

### Регистрация партнера:
1. Владелец создает пригласительную ссылку для партнера
2. Партнер переходит по ссылке → открывается форма регистрации
3. Партнер заполняет:
   - ФИО, номер телефона, email
   - Пароль для основного профиля
4. Система отправляет письмо с подтверждением email
5. Партнер подтверждает email
6. Партнер (основной профиль) может войти по **email + пароль**
7. **Альтернативный профиль контролера создается партнером через ЛК:**
   - Партнер заходит в раздел Настройки
   - Создает контролера с указанием пароля
   - Контролер получает ту же почту (email), но отдельный пароль
   - Роль: `partner_controller`
   - Связь с основным профилем через `main_partner_id`
8. Контролер (альтернативный профиль) может войти по **email + пароль контролера**
9. Пароль контролера можно изменить в настройках основного профиля (после создания)

### Восстановление пароля:
- Работает через email (отправка токена на почту через mail.ru)
- Доступно всем пользователям с подтвержденным email

### Пригласительные ссылки:
- **Разные ссылки для разных ролей** (привязка к роли при создании)
- Владелец может создавать ссылки для: менеджеров, промоутеров, партнеров
- Менеджер может создавать ссылки только для: промоутеров
- **Срок действия**: 1 сутки (24 часа)
- **Однократное использование**: одна ссылка = один аккаунт (после использования `is_used = true`)
- Можно отозвать неиспользованное приглашение (удаление токена)

---

## Система продаж

### Управление балансами (владелец)
- Владелец видит список промоутеров с их балансами (`balance`)
- Владелец видит список менеджеров с их балансами (`balance`) и балансами "Должен компании" (`debt_to_company`)
- Владелец может обнулить баланс (`balance`) у любого промоутера или менеджера
- Владелец может обнулить баланс "Должен компании" (`debt_to_company`) у менеджеров
- При обнулении баланса:
  - Обнуляется только текущий баланс (сумма билетов в статусе `used` на момент обнуления)
  - Билеты в статусе `sold` (продано, но еще не использовано) не учитываются
    - Они еще не были засчитаны в `balance`
    - Когда эти билеты перейдут в статус `used`, баланс будет накапливаться заново
  - После обнуления, если новые билеты перейдут из `sold` в `used`, баланс будет накапливаться с нуля
- При обнулении баланса "Должен компании":
  - Обнуляется только текущий баланс (сумма билетов в статусе `used` или `cancelled` на момент обнуления)
  - Билеты в статусе `sold` не учитываются
- Обнуление доступно через личный кабинет владельца:
  - Баланс: API endpoint `POST /api/users/:id/reset-balance`
  - Баланс "Должен компании": API endpoint `POST /api/users/:id/reset-debt`

