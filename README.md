# Система управления продажей экскурсий

Полнофункциональная система управления промоутерами и продажей экскурсий.

## Технологии

- **Next.js 14** (App Router) с TypeScript
- **Prisma** + PostgreSQL
- **JWT** для аутентификации
- **Tailwind CSS** для стилей
- **React Hook Form** для форм
- **Zustand** для управления состоянием
- **PDFKit** для генерации билетов
- **QRCode** для генерации QR кодов
- **Nodemailer** для отправки email
- **ExcelJS** для экспорта данных
- **Sharp** для обработки изображений

## Установка

1. Установите зависимости:
```bash
npm install
```

2. Настройте переменные окружения:
```bash
cp .env.example .env
```

Отредактируйте `.env` и укажите:
- `DATABASE_URL` - строка подключения к PostgreSQL
- `JWT_SECRET` - секретный ключ для JWT
- `SMTP_*` - настройки Mail.ru SMTP
- `YOOKASSA_*` - настройки ЮКассы

3. Настройте базу данных:
```bash
npx prisma generate
npx prisma db push
```

4. Запустите сервер разработки:
```bash
npm run dev
```

Откройте [http://localhost:3000](http://localhost:3000) в браузере.

## Роли пользователей

1. **Владелец (Owner)** - полный доступ, модерация экскурсий, управление балансами
2. **Помощник владельца (Owner Assistant)** - выдача вещей
3. **Партнер (Partner)** - создание экскурсий, проверка билетов
4. **Контролер партнера (Partner Controller)** - только проверка билетов
5. **Менеджер (Manager)** - продажа билетов (все виды), баланс + долг компании
6. **Промоутер (Promoter)** - продажа билетов (онлайн), баланс

## Основные функции

- ✅ Модерация экскурсий партнеров владельцем
- ✅ Комиссия: процент или фиксированная сумма
- ✅ Система балансов с историей операций
- ✅ Баланс "Должен компании" для менеджеров
- ✅ Обязательное фото лица при регистрации
- ✅ Выдача вещей с фото и историей
- ✅ Интеграция с ЮКассой для онлайн платежей
- ✅ Генерация PDF билетов с QR кодами
- ✅ Экспорт статистики в Excel

## Структура проекта

```
├── app/              # Next.js App Router
│   ├── api/          # API endpoints
│   ├── auth/         # Страницы аутентификации
│   ├── dashboard/    # Дашборды для ролей
│   └── ...
├── components/       # React компоненты
├── lib/              # Утилиты и библиотеки
├── prisma/           # Prisma схема
├── types/            # TypeScript типы
└── utils/            # Вспомогательные функции
```

## Создание первого владельца

После настройки базы данных, создайте первого владельца с помощью скрипта:

```bash
npm run create-owner
```

Скрипт запросит:
- Email владельца
- Пароль владельца
- Пароль помощника владельца

После создания владельца, вы сможете войти в систему и начать работу.

**Важно:** Помощник владельца использует тот же email, но другой пароль.
