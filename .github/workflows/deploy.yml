name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H 91.210.171.176 >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
      
      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@91.210.171.176 << 'ENDSSH'
            set -e
            echo "ðŸš€ ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ..."
            
            cd /var/www/newformat_tour
            
            # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Git Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
            git config --global --add safe.directory /var/www/newformat_tour || true
            
            # ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´ Ð¸Ð· Git
            if [ -d .git ]; then
              echo "ðŸ“¥ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· GitHub..."
              git fetch origin main
              git reset --hard origin/main
            else
              echo "ðŸ“¦ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
              git init
              git config --global --add safe.directory /var/www/newformat_tour
              git remote add origin https://github.com/irwkc/NewFormat_tour.git || git remote set-url origin https://github.com/irwkc/NewFormat_tour.git
              git fetch origin main
              git reset --hard origin/main
            fi
            
            echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
            npm ci --production=false
            
            echo "ðŸ”§ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Prisma Client..."
            npx prisma generate
            
            echo "ðŸ—„ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹..."
            # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð‘Ð” Ð¸Ð· DATABASE_URL Ð¸Ð»Ð¸ .env
            if [ -f .env ]; then
              source .env
            fi
            
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð½Ð° email, ÐµÑÐ»Ð¸ Ð¾Ð½Ð¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
            # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð· DATABASE_URL
            DB_URL="${DATABASE_URL}"
            export PGPASSWORD=$(echo "$DB_URL" | sed -n 's/.*:\/\/[^:]*:\([^@]*\)@.*/\1/p')
            export PGHOST=$(echo "$DB_URL" | sed -n 's/.*@\([^:]*\):.*/\1/p' | sed 's/localhost/127.0.0.1/')
            export PGPORT=$(echo "$DB_URL" | sed -n 's/.*:\([0-9]*\)\/.*/\1/p' | sed 's/[^0-9]//')
            if [ -z "$PGPORT" ]; then export PGPORT=5432; fi
            export PGDATABASE=$(echo "$DB_URL" | sed -n 's/.*\/\([^?]*\).*/\1/p')
            export PGUSER=$(echo "$DB_URL" | sed -n 's/.*:\/\/\([^:]*\):.*/\1/p')
            
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ñ Ð¸ Ð¸Ð½Ð´ÐµÐºÑÑ‹ Ð½Ð° email
            psql -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$PGDATABASE" << 'EOSQL' || echo "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹ (Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ ÑƒÐ¶Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹)"
            -- Ð£Ð´Ð°Ð»ÑÐµÐ¼ constraint ÐµÑÐ»Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
            DO \$\$ 
            BEGIN
                -- Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ
                IF EXISTS (
                    SELECT 1 FROM pg_constraint 
                    WHERE conname = 'users_email_key' 
                    AND conrelid = 'users'::regclass
                ) THEN
                    ALTER TABLE users DROP CONSTRAINT users_email_key;
                    RAISE NOTICE 'Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ users_email_key';
                END IF;
                
                -- Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¸Ð½Ð´ÐµÐºÑ ÐµÑÐ»Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
                IF EXISTS (
                    SELECT 1 FROM pg_indexes 
                    WHERE indexname = 'users_email_key' 
                    AND tablename = 'users'
                ) THEN
                    DROP INDEX users_email_key;
                    RAISE NOTICE 'Ð£Ð´Ð°Ð»ÐµÐ½ Ð¸Ð½Ð´ÐµÐºÑ users_email_key';
                END IF;
                
                -- Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð»ÑŽÐ±Ð¾Ð¹ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¸Ð½Ð´ÐµÐºÑ Ð½Ð° email
                IF EXISTS (
                    SELECT 1 FROM pg_indexes 
                    WHERE indexname LIKE '%email%' 
                    AND tablename = 'users'
                ) THEN
                    DROP INDEX IF EXISTS users_email_key;
                    DROP INDEX IF EXISTS users_email_idx;
                    RAISE NOTICE 'Ð£Ð´Ð°Ð»ÐµÐ½Ñ‹ Ð²ÑÐµ Ð¸Ð½Ð´ÐµÐºÑÑ‹ Ð½Ð° email';
                END IF;
            END \$\$;
            
            -- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ constraint Ñ‡ÐµÑ€ÐµÐ· pg_constraint
            SELECT conname FROM pg_constraint WHERE conrelid = 'users'::regclass AND conname LIKE '%email%';
            DO \$\$
            DECLARE
                constraint_name text;
            BEGIN
                FOR constraint_name IN 
                    SELECT conname FROM pg_constraint 
                    WHERE conrelid = 'users'::regclass 
                    AND conname LIKE '%email%'
                LOOP
                    EXECUTE 'ALTER TABLE users DROP CONSTRAINT IF EXISTS ' || constraint_name;
                    RAISE NOTICE 'Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ: %', constraint_name;
                END LOOP;
            END \$\$;
EOSQL
            
            echo "ðŸ—„ï¸ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹..."
            npx prisma db push --accept-data-loss --skip-generate
            
            echo "ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
            NODE_OPTIONS="--max-old-space-size=1536" npm run build
            
            echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
            pm2 restart newformat-tour || pm2 start npm --name "newformat-tour" -- start
            
            pm2 save
            
            echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
          ENDSSH
      
      - name: Health check
        run: |
          sleep 10
          curl -f https://new-format-spb.ru || exit 1
          echo "âœ… Ð¡Ð°Ð¹Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!"
