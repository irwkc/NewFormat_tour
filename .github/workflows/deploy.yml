name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H 91.210.171.176 >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
      
      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@91.210.171.176 << 'ENDSSH'
            set -e
            echo "ðŸš€ ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ..."
            
            cd /var/www/newformat_tour
            
            # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Git Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
            git config --global --add safe.directory /var/www/newformat_tour || true
            
            # ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´ Ð¸Ð· Git
            if [ -d .git ]; then
              echo "ðŸ“¥ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· GitHub..."
              git fetch origin main
              git reset --hard origin/main
            else
              echo "ðŸ“¦ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
              git init
              git config --global --add safe.directory /var/www/newformat_tour
              git remote add origin https://github.com/irwkc/NewFormat_tour.git || git remote set-url origin https://github.com/irwkc/NewFormat_tour.git
              git fetch origin main
              git reset --hard origin/main
            fi
            
            echo "ðŸ“¦ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
            rm -rf node_modules || true
            
            echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
            # npm ci Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ package-lock.json, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ npm install ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install
            fi
            
            echo "ðŸ”§ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Prisma Client..."
            npx prisma generate
            
            echo "ðŸ—„ï¸ Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸ÐºÐ¾Ð² Ð¸ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÐµÑ€Ð¾Ð²..."
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸ÐºÐ¾Ð² Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ð° Ð¸ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÐµÑ€Ð¾Ð² Ð¿Ð°Ñ€Ñ‚Ð½ÐµÑ€Ð¾Ð²
            # ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð±Ñ‹Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¸ Ð¸Ð¼ÐµÑŽÑ‚ Ñ‚Ð¾Ñ‚ Ð¶Ðµ email
            echo "DELETE FROM users WHERE role = 'owner_assistant'; DELETE FROM users WHERE role = 'partner_controller';" | npx prisma db execute --stdin || echo "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ (Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ ÑƒÐ¶Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹)"
            
            echo "ðŸ—„ï¸ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹..."
            npx prisma db push --accept-data-loss --skip-generate
            
            echo "ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
            NODE_OPTIONS="--max-old-space-size=1536" npm run build
            
            echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
            pm2 restart newformat-tour || pm2 start npm --name "newformat-tour" -- start
            
            pm2 save
            
            echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
          ENDSSH
      
      - name: Health check
        run: |
          sleep 10
          curl -f https://new-format-spb.ru || exit 1
          echo "âœ… Ð¡Ð°Ð¹Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!"
