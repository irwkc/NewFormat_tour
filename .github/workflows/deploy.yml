name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H 91.210.171.176 >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
      
      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@91.210.171.176 << 'ENDSSH'
            set -e
            echo "ðŸš€ ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ..."
            
            cd /var/www/newformat_tour
            
            # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Git Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
            git config --global --add safe.directory /var/www/newformat_tour || true
            
            # ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´ Ð¸Ð· Git
            if [ -d .git ]; then
              echo "ðŸ“¥ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· GitHub..."
              git fetch origin main
              git reset --hard origin/main
            else
              echo "ðŸ“¦ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Git Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ..."
              git init
              git config --global --add safe.directory /var/www/newformat_tour
              git remote add origin https://github.com/irwkc/NewFormat_tour.git || git remote set-url origin https://github.com/irwkc/NewFormat_tour.git
              git fetch origin main
              git reset --hard origin/main
            fi
            
            echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
            npm ci --production=false
            
            echo "ðŸ”§ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Prisma Client..."
            npx prisma generate
            
            echo "ðŸ—„ï¸ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹..."
            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð½Ð° email, ÐµÑÐ»Ð¸ Ð¾Ð½Ð¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
            npx prisma db execute --stdin << 'SQL' || true
DO $$ 
BEGIN
    -- Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð½Ð° email, ÐµÑÐ»Ð¸ Ð¾Ð½Ð¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
    IF EXISTS (
        SELECT 1 FROM pg_constraint 
        WHERE conname = 'users_email_key' 
        AND conrelid = 'users'::regclass
    ) THEN
        ALTER TABLE users DROP CONSTRAINT users_email_key;
        RAISE NOTICE 'Ð£Ð´Ð°Ð»ÐµÐ½Ð¾ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ users_email_key';
    END IF;
    
    -- Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¸Ð½Ð´ÐµÐºÑ, ÐµÑÐ»Ð¸ Ð¾Ð½ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ ÐºÐ°Ðº ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹
    IF EXISTS (
        SELECT 1 FROM pg_indexes 
        WHERE indexname = 'users_email_key' 
        AND tablename = 'users'
    ) THEN
        DROP INDEX IF EXISTS users_email_key;
        RAISE NOTICE 'Ð£Ð´Ð°Ð»ÐµÐ½ Ð¸Ð½Ð´ÐµÐºÑ users_email_key';
    END IF;
END $$;
SQL
            
            echo "ðŸ—„ï¸ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹..."
            npx prisma db push --accept-data-loss --skip-generate
            
            echo "ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
            NODE_OPTIONS="--max-old-space-size=1536" npm run build
            
            echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
            pm2 restart newformat-tour || pm2 start npm --name "newformat-tour" -- start
            
            pm2 save
            
            echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
          ENDSSH
      
      - name: Health check
        run: |
          sleep 10
          curl -f https://new-format-spb.ru || exit 1
          echo "âœ… Ð¡Ð°Ð¹Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!"
