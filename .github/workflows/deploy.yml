name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H 91.210.171.176 >> ~/.ssh/known_hosts 2>/dev/null
          chmod 600 ~/.ssh/known_hosts
      
      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 root@91.210.171.176 << 'ENDSSH'
            set -e
            echo "ðŸš€ ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ñ..."
            
            cd /var/www/newformat_tour
            
            # Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚ Ð´Ð»Ñ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ
            PREV_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "")
            
            # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Git Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
            git config --global --add safe.directory /var/www/newformat_tour 2>/dev/null || true
            
            # ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´ Ð¸Ð· Git
            echo "ðŸ“¥ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· GitHub..."
            git fetch origin main --quiet
            NEW_COMMIT=$(git rev-parse origin/main)
            git reset --hard origin/main --quiet
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ñ„Ð°Ð¹Ð»Ð¾Ð²
            PACKAGE_CHANGED=true
            SCHEMA_CHANGED=true
            
            if [ -n "$PREV_COMMIT" ] && [ "$PREV_COMMIT" != "$NEW_COMMIT" ]; then
              if git diff --quiet "$PREV_COMMIT" "$NEW_COMMIT" -- package.json package-lock.json 2>/dev/null; then
                PACKAGE_CHANGED=false
              fi
              if git diff --quiet "$PREV_COMMIT" "$NEW_COMMIT" -- prisma/schema.prisma 2>/dev/null; then
                SCHEMA_CHANGED=false
              fi
            fi
            
            # ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ÑÑŒ
            if [ "$PACKAGE_CHANGED" = true ] || [ ! -d node_modules ]; then
              echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
              rm -rf node_modules 2>/dev/null || true
              npm ci --silent --no-audit --no-fund 2>&1 | grep -v "^npm WARN" || true
            else
              echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ÑÑŒ, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ"
            fi
            
            # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Prisma Client (Ð²ÑÐµÐ³Ð´Ð° Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐ¾Ð´Ð°)
            echo "ðŸ”§ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Prisma Client..."
            rm -rf node_modules/.prisma 2>/dev/null || true
            npx prisma generate --silent 2>&1 | grep -v "^Start by importing\|^Tip:" || true
            
            # ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð°ÑÑŒ ÑÑ…ÐµÐ¼Ð°)
            if [ "$SCHEMA_CHANGED" = true ]; then
              echo "ðŸ—„ï¸ ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹..."
              npx prisma db push --accept-data-loss --skip-generate --silent 2>&1 | grep -v "^Environment\|^Prisma schema\|^Datasource\|^Tip:" || true
            else
              echo "âœ… Prisma ÑÑ…ÐµÐ¼Ð° Ð½Ðµ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð°ÑÑŒ, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸"
            fi
            
            # Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            echo "ðŸ—ï¸ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
            NODE_OPTIONS="--max-old-space-size=1536" npm run build --silent 2>&1 | grep -v "^npm WARN\|^Start by importing\|^Tip:" || true
            
            # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
            echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
            pm2 restart newformat-tour --silent 2>/dev/null || pm2 start npm --name "newformat-tour" -- start --silent 2>/dev/null
            pm2 save --silent 2>/dev/null
            
            echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
          ENDSSH
      
      - name: Health check
        timeout-minutes: 2
        run: |
          sleep 5
          curl -f --max-time 10 https://new-format-spb.ru || exit 1
          echo "âœ… Ð¡Ð°Ð¹Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!"
